<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é«˜çŸ¥ é˜²ç½è¡Œå‹•ãƒŠãƒ“</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:sans-serif; }
#map { height:100vh; }
.panel {
  position: fixed;
  top: 10px;
  left: 10px;
  background: white;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  z-index: 1000;
}
button {
  width: 100%;
  margin-top: 5px;
  padding: 8px;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="panel">
  <b>é«˜çŸ¥ é˜²ç½è¡Œå‹•ãƒŠãƒ“</b><br>
  <button onclick="getLocation()">ğŸ“ ç¾åœ¨åœ°</button>
  <button onclick="showShelters()">ğŸ« é¿é›£æ‰€è¡¨ç¤º</button>
  <button onclick="routeToShelter()">â¡ æœ€å¯„ã‚Šé¿é›£æ‰€ã¸</button>
</div>

<div id="map"></div>

<script>
var map = L.map('map').setView([33.5597, 133.5311], 13); // é«˜çŸ¥å¸‚

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

var userMarker;
var shelterMarkers = [];
var routeLine;

var shelters = [
  {name:"é«˜çŸ¥å¸‚ç·åˆé‹å‹•å ´", lat:33.571, lng:133.541},
  {name:"é«˜çŸ¥å¸‚ç«‹ä¸€å®®å°å­¦æ ¡", lat:33.583, lng:133.565},
  {name:"é«˜çŸ¥å¸‚ç«‹æ½®æ±Ÿä¸­å­¦æ ¡", lat:33.545, lng:133.521},
  {name:"é«˜çŸ¥å¸‚ç«‹æ—­å°å­¦æ ¡", lat:33.560, lng:133.499}
];

function getLocation(){
  navigator.geolocation.getCurrentPosition(function(pos){
    var lat = pos.coords.latitude;
    var lng = pos.coords.longitude;

    if(userMarker) map.removeLayer(userMarker);

    userMarker = L.marker([lat,lng]).addTo(map)
      .bindPopup("ç¾åœ¨åœ°").openPopup();

    map.setView([lat,lng],15);
  });
}

function showShelters(){
  shelterMarkers.forEach(m => map.removeLayer(m));
  shelterMarkers = [];

  shelters.forEach(s => {
    var m = L.marker([s.lat, s.lng]).addTo(map)
      .bindPopup("é¿é›£æ‰€: " + s.name);
    shelterMarkers.push(m);
  });
}

function routeToShelter(){
  if(!userMarker){
    alert("å…ˆã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„");
    return;
  }

  var userLatLng = userMarker.getLatLng();
  var nearest = shelters[0];
  var minDist = 999;

  shelters.forEach(s=>{
    var d = Math.sqrt(
      Math.pow(userLatLng.lat - s.lat,2) +
      Math.pow(userLatLng.lng - s.lng,2)
    );
    if(d < minDist){
      minDist = d;
      nearest = s;
    }
  });

  if(routeLine) map.removeLayer(routeLine);

  routeLine = L.polyline([
    [userLatLng.lat, userLatLng.lng],
    [nearest.lat, nearest.lng]
  ]).addTo(map);

  L.popup()
    .setLatLng([nearest.lat, nearest.lng])
    .setContent("æœ€å¯„ã‚Šé¿é›£æ‰€: " + nearest.name)
    .openOn(map);
}
</script>

</body>
</html>
